from __future__ import annotations

from typing import Any, cast

from PySide6.QtWidgets import (
    QHBoxLayout,
    QLabel,
    QMainWindow,
    QPushButton,
    QTabWidget,
    QVBoxLayout,
    QWidget,
)


class UISetupManager:
    """UI ÏÑ§Ï†ï Í¥ÄÎ¶¨ ÌÅ¥ÎûòÏä§"""

    def __init__(self, parent: QMainWindow):
        self.parent = cast(Any, parent)

    def setup_ui(self) -> None:
        """UI ÏÑ§Ï†ï"""
        central_widget = QWidget()
        self.parent.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)
        layout.setContentsMargins(16, 16, 16, 16)
        layout.setSpacing(12)

        # Ìó§Îçî
        self.setup_header(layout)

        # ÌÉ≠ ÏúÑÏ†Ø
        self.setup_tabs(layout)

        # Î≤ÑÌäº ÏòÅÏó≠
        self.setup_buttons(layout)

    def setup_header(self, layout: QVBoxLayout) -> None:
        """Ìó§Îçî ÏÑ§Ï†ï"""
        header_label = QLabel("‚öôÔ∏è ÏÑ§Ï†ï")
        header_label.setStyleSheet(
            """
            QLabel {
                color: #111827;
                font-size: 18px;
                font-weight: 600;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin-bottom: 8px;
            }
        """
        )
        layout.addWidget(header_label)

        desc_label = QLabel("DS PilotÏùò LLM Ïó∞Í≤∞ ÏÑ§Ï†ïÍ≥º UI ÏÑ§Ï†ïÏùÑ Íµ¨ÏÑ±ÌïòÏÑ∏Ïöî.")
        desc_label.setStyleSheet(
            """
            QLabel {
                color: #6B7280;
                font-size: 11px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin-bottom: 12px;
            }
        """
        )
        layout.addWidget(desc_label)

    def setup_tabs(self, layout: QVBoxLayout) -> None:
        """ÌÉ≠ ÏúÑÏ†Ø ÏÑ§Ï†ï"""
        self.parent.tab_widget = QTabWidget()
        self.parent.tab_widget.setStyleSheet(
            """
            QTabWidget::pane {
                border: 1px solid #E5E7EB;
                border-radius: 6px;
                background-color: #FFFFFF;
            }
            QTabWidget::tab-bar {
                alignment: left;
            }
            QTabBar::tab {
                background-color: #F9FAFB;
                color: #6B7280;
                border: 1px solid #E5E7EB;
                padding: 8px 16px;
                margin-right: 2px;
                font-weight: 500;
                font-size: 11px;
                border-bottom: none;
                border-top-left-radius: 6px;
                border-top-right-radius: 6px;
            }
            QTabBar::tab:selected {
                background-color: #FFFFFF;
                color: #2563EB;
                border-bottom: 1px solid #FFFFFF;
                font-weight: 600;
            }
            QTabBar::tab:hover {
                background-color: #F3F4F6;
                color: #374151;
            }
        """
        )

        # ÌÉ≠ Ï∂îÍ∞Ä
        self.parent.llm_tab = self.parent.llm_tab_manager.create_llm_tab()
        self.parent.tab_widget.addTab(self.parent.llm_tab, "ü§ñ LLM ÏÑ§Ï†ï")

        self.parent.ui_tab = self.parent.ui_tab_manager.create_ui_tab()
        self.parent.tab_widget.addTab(self.parent.ui_tab, "üé® UI ÏÑ§Ï†ï")

        self.parent.mcp_tab = self.parent.mcp_tab_manager.create_mcp_tab()
        self.parent.tab_widget.addTab(self.parent.mcp_tab, "üîß MCP ÏÑ§Ï†ï")

        self.parent.github_tab = self.parent.github_tab_manager.create_github_tab()
        self.parent.tab_widget.addTab(self.parent.github_tab, "üêô GitHub ÏÑ§Ï†ï")

        self.parent.task_tab = self.parent.task_tab_manager.create_task_tab()
        self.parent.tab_widget.addTab(self.parent.task_tab, "‚è∞ ÏûëÏóÖ Ïä§ÏºÄÏ§Ñ")

        layout.addWidget(self.parent.tab_widget)

    def setup_buttons(self, layout: QVBoxLayout) -> None:
        """Î≤ÑÌäº ÏòÅÏó≠ ÏÑ§Ï†ï"""
        button_layout = QHBoxLayout()
        button_layout.setSpacing(8)

        # ÌÖåÏä§Ìä∏ Î≤ÑÌäº (LLM ÌÉ≠ÏóêÏÑúÎßå)
        self.parent.test_button = QPushButton("üß™ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏")
        self.parent.test_button.setStyleSheet(
            """
            QPushButton {
                background-color: #F59E0B;
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                font-size: 11px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 8px 16px;
                min-width: 100px;
            }
            QPushButton:hover {
                background-color: #D97706;
            }
            QPushButton:pressed {
                background-color: #B45309;
            }
        """
        )
        self.parent.test_button.clicked.connect(self.parent.llm_tab_manager.test_connection)

        # Í∏∞Î≥∏Í∞í Î≥µÏõê Î≤ÑÌäº
        reset_button = QPushButton("üîÑ Í∏∞Î≥∏Í∞í Î≥µÏõê")
        reset_button.setStyleSheet(
            """
            QPushButton {
                background-color: #9CA3AF;
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                font-size: 11px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 8px 16px;
                min-width: 100px;
            }
            QPushButton:hover {
                background-color: #6B7280;
            }
            QPushButton:pressed {
                background-color: #4B5563;
            }
        """
        )
        reset_button.clicked.connect(self.parent.settings_manager.reset_to_defaults)

        # Ï∑®ÏÜå Î≤ÑÌäº
        cancel_button = QPushButton("Ï∑®ÏÜå")
        cancel_button.setStyleSheet(
            """
            QPushButton {
                background-color: #6B7280;
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                font-size: 11px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 8px 16px;
                min-width: 60px;
            }
            QPushButton:hover {
                background-color: #4B5563;
            }
            QPushButton:pressed {
                background-color: #374151;
            }
        """
        )
        cancel_button.clicked.connect(self.parent.close)

        # Ï†ÄÏû• Î≤ÑÌäº
        save_button = QPushButton("üíæ Ï†ÄÏû•")
        save_button.setStyleSheet(
            """
            QPushButton {
                background-color: #10B981;
                color: white;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                font-size: 11px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 8px 16px;
                min-width: 60px;
            }
            QPushButton:hover {
                background-color: #059669;
            }
            QPushButton:pressed {
                background-color: #047857;
            }
        """
        )
        save_button.clicked.connect(self.parent.settings_manager.save_settings)

        # ÌÉ≠ Î≥ÄÍ≤Ω Ïãú ÌÖåÏä§Ìä∏ Î≤ÑÌäº ÌëúÏãú/Ïà®Í∏∞Í∏∞
        self.parent.tab_widget.currentChanged.connect(self.parent.on_tab_changed)

        button_layout.addWidget(self.parent.test_button)
        button_layout.addWidget(reset_button)
        button_layout.addStretch()
        button_layout.addWidget(cancel_button)
        button_layout.addWidget(save_button)

        layout.addLayout(button_layout)

    def update_theme(self) -> None:
        """ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏"""
        try:
            if hasattr(self.parent, "theme_manager"):
                colors = self.parent.theme_manager.get_theme_colors()

                # Ìó§Îçî ÎùºÎ≤®Îì§ ÏóÖÎç∞Ïù¥Ìä∏
                self._update_header_theme(colors)

                # ÌÉ≠ ÏúÑÏ†Ø ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏
                self._update_tab_widget_theme(colors)

                # Î≤ÑÌäºÎì§ ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏
                self._update_buttons_theme(colors)

        except Exception as e:
            print(f"ÏÑ§Ï†ïÏ∞Ω ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: {e}")

    def _update_header_theme(self, colors: dict[str, str]) -> None:
        """Ìó§Îçî ÏòÅÏó≠ ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏"""
        # Ìó§Îçî ÎùºÎ≤® Ïä§ÌÉÄÏùºÏùÄ setup_headerÏóêÏÑú ÏßÅÏ†ë Ï∞∏Ï°∞ÌïòÎäî ÏúÑÏ†ØÏù¥ ÏóÜÏúºÎØÄÎ°ú
        # ÌïÑÏöîÏãú ÏúÑÏ†Ø Ï∞∏Ï°∞Î•º Ï†ÄÏû•Ìï¥ÏÑú ÏóÖÎç∞Ïù¥Ìä∏

    def _update_tab_widget_theme(self, colors: dict[str, str]) -> None:
        """ÌÉ≠ ÏúÑÏ†Ø ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏"""
        if hasattr(self.parent, "tab_widget"):
            self.parent.tab_widget.setStyleSheet(
                f"""
                QTabWidget::pane {{
                    border: 1px solid {colors['border']};
                    border-radius: 6px;
                    background-color: {colors['background']};
                }}
                QTabWidget::tab-bar {{
                    alignment: left;
                }}
                QTabBar::tab {{
                    background-color: {colors['surface']};
                    color: {colors['text_secondary']};
                    border: 1px solid {colors['border']};
                    padding: 8px 16px;
                    margin-right: 2px;
                    font-weight: 500;
                    font-size: 11px;
                    border-bottom: none;
                    border-top-left-radius: 6px;
                    border-top-right-radius: 6px;
                }}
                QTabBar::tab:selected {{
                    background-color: {colors['background']};
                    color: {colors['primary']};
                    border-bottom: 1px solid {colors['background']};
                    font-weight: 600;
                }}
                QTabBar::tab:hover {{
                    background-color: {colors['button_hover']};
                    color: {colors['text']};
                }}
            """
            )

    def _update_buttons_theme(self, colors: dict[str, str]) -> None:
        """Î≤ÑÌäºÎì§ ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏"""
        try:
            # ÌÖåÏä§Ìä∏ Î≤ÑÌäº
            if hasattr(self.parent, "test_button"):
                self.parent.test_button.setStyleSheet(
                    f"""
                    QPushButton {{
                        background-color: {colors['warning']};
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        font-size: 11px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        padding: 8px 16px;
                        min-width: 100px;
                    }}
                    QPushButton:hover {{
                        background-color: {colors.get('warning_hover', colors['warning'])};
                    }}
                    QPushButton:pressed {{
                        background-color: {colors.get('warning_pressed', colors['warning'])};
                    }}
                """
                )
        except Exception as e:
            print(f"Î≤ÑÌäº ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: {e}")
