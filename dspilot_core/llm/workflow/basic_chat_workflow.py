"""
ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì›Œí¬í”Œë¡œìš° (BasicChatWorkflow)
============================================

ìˆœìˆ˜ LLM ê¸°ë°˜ì˜ ë¹ ë¥´ê³  ê°„ê²°í•œ ì§ˆì˜ì‘ë‹µ ì›Œí¬í”Œë¡œìš°ì…ë‹ˆë‹¤.
ì™¸ë¶€ ë„êµ¬ë‚˜ ë³µì¡í•œ ì²˜ë¦¬ ì—†ì´ LLMì˜ ê¸°ë³¸ ì§€ì‹ë§Œìœ¼ë¡œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.

Cursor/Clineì˜ Ask ëª¨ë“œì™€ ìœ ì‚¬í•œ ë‹¨ìˆœí•˜ê³  ì§ì ‘ì ì¸ AI ëŒ€í™” ë°©ì‹ì„ ì œê³µí•˜ë©°,
ë¹ ë¥¸ ì‘ë‹µ ì†ë„ì™€ ê°„ê²°í•œ ìƒí˜¸ì‘ìš©ì´ íŠ¹ì§•ì…ë‹ˆë‹¤.

ì£¼ìš” íŠ¹ì§•
=========

1. **ìˆœìˆ˜ LLM ì‘ë‹µ**
   - ì™¸ë¶€ ë„êµ¬ ì‚¬ìš© ì—†ì´ LLM ê¸°ë³¸ ì§€ì‹ë§Œ í™œìš©
   - ë¹ ë¥¸ ì‘ë‹µ ì†ë„ ë³´ì¥
   - ë„¤íŠ¸ì›Œí¬ë‚˜ ë„êµ¬ ì˜ì¡´ì„± ì—†ìŒ

2. **ì§ˆë¬¸ ìœ í˜•ë³„ ìµœì í™”**
   - í”„ë¡œê·¸ë˜ë°, ì„¤ëª…, ë¹„êµ, ë¬¸ì œí•´ê²° ë“± ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”
   - ê° ì§ˆë¬¸ ìœ í˜•ì— ë§ëŠ” êµ¬ì¡°í™”ëœ ì‘ë‹µ ì œê³µ

3. **ê°„ê²°í•œ ìƒí˜¸ì‘ìš©**
   - ë³µì¡í•œ ë‹¤ë‹¨ê³„ ì²˜ë¦¬ ì—†ìŒ
   - ì§ê´€ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì‘ë‹µ íŒ¨í„´

ì‚¬ìš© ê¶Œì¥ ìƒí™©
=============

### ì í•©í•œ ì‚¬ìš© ì‚¬ë¡€:
- ì¼ë°˜ì ì¸ ì§€ì‹ ì§ˆë¬¸ ë° ì •ë³´ ìš”ì²­
- í”„ë¡œê·¸ë˜ë° ê°œë… ì„¤ëª… ë° ì½”ë“œ ë„ì›€
- ë¹ ë¥¸ ìƒë‹´ì´ë‚˜ ì¡°ì–¸ì´ í•„ìš”í•œ ê²½ìš°
- ì¸í„°ë„· ì—°ê²°ì´ ë¶ˆì•ˆì •í•˜ê±°ë‚˜ ë„êµ¬ ì‚¬ìš©ì´ ì œí•œëœ í™˜ê²½
- ë‹¨ìˆœí•˜ê³  ì§ì ‘ì ì¸ ë‹µë³€ì„ ì›í•˜ëŠ” ê²½ìš°

### ë¶€ì í•©í•œ ì‚¬ìš© ì‚¬ë¡€:
- ì‹¤ì‹œê°„ ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš° (ë‚ ì”¨, ë‰´ìŠ¤, ì£¼ì‹ ë“±)
- íŒŒì¼ ì½ê¸°/ì“°ê¸°ë‚˜ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ì´ í•„ìš”í•œ ì‘ì—…
- ë³µì¡í•œ ê³„ì‚°ì´ë‚˜ ë°ì´í„° ì²˜ë¦¬ ì‘ì—…
- ì›¹ ê²€ìƒ‰ì´ë‚˜ ìµœì‹  ì •ë³´ ì¡°íšŒê°€ í•„ìš”í•œ ê²½ìš°

ì§ˆë¬¸ ìœ í˜•ë³„ ìµœì í™”
================

### 1. ì½”ë”©/í”„ë¡œê·¸ë˜ë° (code_help)
**ê°ì§€ í‚¤ì›Œë“œ**: ì½”ë“œ, í”„ë¡œê·¸ë˜ë°, í•¨ìˆ˜, ì—ëŸ¬, ë²„ê·¸, python, javascript ë“±
**ìµœì í™” ë‚´ìš©**:
- í•µì‹¬ í•´ê²° ë°©ë²• ì œì‹œ
- ê°„ë‹¨í•œ ì½”ë“œ ì˜ˆì‹œ í¬í•¨
- ì£¼ì˜ì‚¬í•­ ë° íŒ ì œê³µ

### 2. ì„¤ëª… ìš”ì²­ (explanation) 
**ê°ì§€ í‚¤ì›Œë“œ**: ì„¤ëª…, ë­ì•¼, ë¬´ì—‡, what, explain, ì°¨ì´, ì–´ë–»ê²Œ, ì™œ ë“±
**ìµœì í™” ë‚´ìš©**:
- í•µì‹¬ ê°œë…ì„ ëª…í™•íˆ ì„¤ëª…
- êµ¬ì²´ì ì¸ ì˜ˆì‹œ í¬í•¨
- ë‹¨ê³„ë³„ ì •ë¦¬

### 3. ë¹„êµ ìš”ì²­ (comparison)
**ê°ì§€ í‚¤ì›Œë“œ**: ë¹„êµ, compare, vs, ì°¨ì´ì , ì¥ë‹¨ì , ì–´ëŠê²Œ ë“±
**ìµœì í™” ë‚´ìš©**:
- ì£¼ìš” ì°¨ì´ì ê³¼ ê³µí†µì 
- ê°ê°ì˜ ì¥ë‹¨ì 
- ì‚¬ìš© ìƒí™©ë³„ ê¶Œì¥ì‚¬í•­

### 4. ë¬¸ì œ í•´ê²° (troubleshooting)
**ê°ì§€ í‚¤ì›Œë“œ**: ë¬¸ì œ, ì•ˆë¼, ì˜¤ë¥˜, ì—ëŸ¬, í•´ê²°, ê³ ì¹˜, ì‘ë™ ë“±
**ìµœì í™” ë‚´ìš©**:
- ê°€ëŠ¥í•œ ì›ì¸ë“¤
- ë‹¨ê³„ë³„ í•´ê²° ë°©ë²•
- ì˜ˆë°© ë°©ë²•

### 5. ì¼ë°˜ ì§ˆë¬¸ (general)
**ê¸°ë³¸ ì²˜ë¦¬**: ì¶”ê°€ í”„ë¡¬í”„íŠ¸ ìµœì í™” ì—†ì´ ì›ë³¸ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì „ë‹¬

ì‚¬ìš©ë²• ë° ì˜ˆì‹œ
=============

### 1. ê¸°ë³¸ ì‚¬ìš©ë²•

```python
from dspilot_core.llm.workflow import BasicChatWorkflow

# ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™”
workflow = BasicChatWorkflow()

# ì‹¤í–‰
result = await workflow.run(agent, "Pythonì—ì„œ ë¦¬ìŠ¤íŠ¸ì™€ íŠœí”Œì˜ ì°¨ì´ì ì€?", streaming_callback)
```

### 2. ì—ì´ì „íŠ¸ì—ì„œ ì‚¬ìš©

```python
class ProblemAgent(BaseAgent):
    def _get_workflow_name(self, mode: str) -> str:
        if mode == "basic":
            return "basic"  # BasicChatWorkflow ì‚¬ìš©
        # ... ë‹¤ë¥¸ ëª¨ë“œë“¤
```

### 3. ìŠ¤íŠ¸ë¦¬ë°ê³¼ í•¨ê»˜ ì‚¬ìš©

```python
def chat_callback(content: str):
    print(f"ğŸ’¬ {content}", end="", flush=True)

result = await workflow.run(
    agent=my_agent,
    message="FastAPIì™€ Flaskì˜ ì°¨ì´ì ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”",
    streaming_callback=chat_callback
)
```

ë‚´ë¶€ ë™ì‘ ì›ë¦¬
=============

### ì²˜ë¦¬ íë¦„
1. **ì§ˆë¬¸ ìœ í˜• ê°ì§€**: í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜
2. **í”„ë¡¬í”„íŠ¸ ìµœì í™”**: ìœ í˜•ë³„ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
3. **LLM ì‘ë‹µ ìƒì„±**: agent._generate_basic_response() í˜¸ì¶œ
4. **ê²°ê³¼ ë°˜í™˜**: ìƒì„±ëœ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ë°˜í™˜

### ì§ˆë¬¸ ìœ í˜• ê°ì§€ ì•Œê³ ë¦¬ì¦˜
```python
def _detect_question_type(self, message: str) -> str:
    message_lower = message.lower()
    
    # í‚¤ì›Œë“œ ê¸°ë°˜ ë§¤ì¹­
    if any(keyword in message_lower for keyword in code_keywords):
        return "code_help"
    elif any(keyword in message_lower for keyword in explain_keywords):
        return "explanation"
    # ... ê¸°íƒ€ ìœ í˜•ë“¤
    else:
        return "general"
```

ì„±ëŠ¥ íŠ¹ì„±
=========

### ì¥ì 
- **ë¹ ë¥¸ ì‘ë‹µ**: ì™¸ë¶€ ë„êµ¬ í˜¸ì¶œ ì—†ì´ ì¦‰ì‹œ ì‘ë‹µ
- **ì•ˆì •ì„±**: ë„¤íŠ¸ì›Œí¬ë‚˜ ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ  
- **ì˜ˆì¸¡ ê°€ëŠ¥**: ì¼ê´€ëœ ì‘ë‹µ íŒ¨í„´
- **ë¦¬ì†ŒìŠ¤ íš¨ìœ¨**: ìµœì†Œí•œì˜ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©

### ì œí•œì‚¬í•­
- **ì •ë³´ í•œê³„**: LLM í›ˆë ¨ ë°ì´í„° ê¸°ì¤€ ì‹œì ì˜ ì •ë³´ë§Œ í™œìš©
- **ì‹¤ì‹œê°„ì„± ë¶€ì¡±**: ìµœì‹  ì •ë³´ë‚˜ ì‹¤ì‹œê°„ ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€
- **ë„êµ¬ ì—°ë™ ë¶ˆê°€**: íŒŒì¼ ì‹œìŠ¤í…œ, ì›¹ API ë“± ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ë¶ˆê°€
- **ë³µì¡í•œ ê³„ì‚° í•œê³„**: ì •í™•í•œ ìˆ˜ì¹˜ ê³„ì‚°ì´ë‚˜ ë°ì´í„° ì²˜ë¦¬ì— í•œê³„

ìµœì í™” íŒ
=========

### íš¨ê³¼ì ì¸ ì§ˆë¬¸ ë°©ë²•
1. **êµ¬ì²´ì ì¸ ì§ˆë¬¸**: "Python ë¦¬ìŠ¤íŠ¸ ì •ë ¬ ë°©ë²•" vs "Python ë„ì›€ë§"
2. **ì»¨í…ìŠ¤íŠ¸ ì œê³µ**: "ì›¹ ê°œë°œ ì´ˆë³´ìë¥¼ ìœ„í•œ JavaScript ì„¤ëª…"
3. **ëª…í™•í•œ ëª©ì **: "ë©´ì ‘ ì¤€ë¹„ìš© ì•Œê³ ë¦¬ì¦˜ ì„¤ëª…"

### ì‘ë‹µ í’ˆì§ˆ í–¥ìƒ
- ì§ˆë¬¸ ìœ í˜•ì— ë§ëŠ” í‚¤ì›Œë“œ ì‚¬ìš©
- ë‹¨ê³„ë³„ ì„¤ëª…ì´ í•„ìš”í•œ ê²½ìš° ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­
- ì˜ˆì‹œê°€ í•„ìš”í•œ ê²½ìš° "ì˜ˆì‹œì™€ í•¨ê»˜" ëª…ì‹œ

ë¬¸ì œ í•´ê²°
=========

### ì‘ë‹µì´ ë¶€ì •í™•í•œ ê²½ìš°
- ë” êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì§ˆë¬¸ìœ¼ë¡œ ì¬ì‹œë„
- ì§ˆë¬¸ì„ ì—¬ëŸ¬ ê°œì˜ ì‘ì€ ì§ˆë¬¸ìœ¼ë¡œ ë¶„í• 
- í•„ìš”í•œ ì»¨í…ìŠ¤íŠ¸ë‚˜ ë°°ê²½ ì •ë³´ ì¶”ê°€ ì œê³µ

### ì‘ë‹µì´ ë„ˆë¬´ ê°„ë‹¨í•œ ê²½ìš°
- "ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”" ì¶”ê°€
- "ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”" ìš”ì²­
- "ì˜ˆì‹œì™€ í•¨ê»˜ ì„¤ëª…í•´ì£¼ì„¸ìš”" ëª…ì‹œ

### ì—ëŸ¬ ë°œìƒ ì‹œ
- ì—ì´ì „íŠ¸ì˜ _generate_basic_response ë©”ì„œë“œ í™•ì¸
- ë¡œê·¸ì—ì„œ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸
- ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë° LLM ì„œë¹„ìŠ¤ ìƒíƒœ ì ê²€
"""

import logging
from typing import Any, Callable, Optional

from dspilot_core.llm.workflow.base_workflow import BaseWorkflow
from dspilot_core.util.logger import setup_logger

logger = setup_logger("basic_chat_workflow") or logging.getLogger("basic_chat_workflow")


class BasicChatWorkflow(BaseWorkflow):
    """
    ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì›Œí¬í”Œë¡œìš°
    
    ìˆœìˆ˜ LLM ê¸°ë°˜ì˜ ë¹ ë¥´ê³  ê°„ê²°í•œ ì§ˆì˜ì‘ë‹µì„ ì œê³µí•©ë‹ˆë‹¤.
    ì™¸ë¶€ ë„êµ¬ ì‚¬ìš© ì—†ì´ LLMì˜ ê¸°ë³¸ ì§€ì‹ë§Œìœ¼ë¡œ ì‘ë‹µì„ ìƒì„±í•˜ë©°,
    ì§ˆë¬¸ ìœ í˜•ë³„ë¡œ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    
    Cursor/Clineì˜ Ask ëª¨ë“œì™€ ìœ ì‚¬í•œ ë‹¨ìˆœí•˜ê³  ì§ì ‘ì ì¸ AI ëŒ€í™” ë°©ì‹ìœ¼ë¡œ,
    ë¹ ë¥¸ ì‘ë‹µ ì†ë„ì™€ ê°„ê²°í•œ ìƒí˜¸ì‘ìš©ì´ íŠ¹ì§•ì…ë‹ˆë‹¤.
    
    ì£¼ìš” íŠ¹ì§•:
    - ìˆœìˆ˜ LLM ì‘ë‹µ (ì™¸ë¶€ ë„êµ¬ ì‚¬ìš© ì—†ìŒ)
    - ì§ˆë¬¸ ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ìµœì í™”
    - ë¹ ë¥¸ ì‘ë‹µ ì†ë„
    - ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‘
    """

    async def run(
        self, agent: Any, message: str, streaming_callback: Optional[Callable[[str], None]] = None
    ) -> str:
        """
        ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

        ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ìœ í˜•ë³„ë¡œ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ê³ ,
        ìˆœìˆ˜ LLM ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.

        Args:
            agent: LLM ì—ì´ì „íŠ¸ (BaseAgent ì¸ìŠ¤í„´ìŠ¤)
            message: ì‚¬ìš©ì ì§ˆë¬¸
            streaming_callback: ìŠ¤íŠ¸ë¦¬ë° ì½œë°± í•¨ìˆ˜ (ì„ íƒì‚¬í•­)

        Returns:
            str: AI ìƒì„± ì‘ë‹µ

        Raises:
            Exception: ì—ì´ì „íŠ¸ ì„¤ì • ë¬¸ì œë‚˜ LLM ì„œë¹„ìŠ¤ ì˜¤ë¥˜ ì‹œ
        """
        try:
            logger.info(f"ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì‹œì‘: {message[:50]}...")

            if streaming_callback:
                streaming_callback("ğŸ’¬ ")

            # ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¥¸ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
            optimized_prompt = self._optimize_prompt(message)

            # ìˆœìˆ˜ LLM ê¸°ë°˜ ì‘ë‹µ ìƒì„± (ë„êµ¬ ì‚¬ìš© ì—†ìŒ)
            if hasattr(agent, "_generate_basic_response"):
                result = await agent._generate_basic_response(optimized_prompt, streaming_callback)
                logger.info("ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì™„ë£Œ")
                return result
            else:
                logger.error("ì—ì´ì „íŠ¸ì— ê¸°ë³¸ ì‘ë‹µ ìƒì„± ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤")
                return "ì—ì´ì „íŠ¸ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. _generate_basic_response ë©”ì„œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤."

        except Exception as e:
            logger.error(f"ê¸°ë³¸ ì§ˆì˜ì‘ë‹µ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")
            return f"ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

    def _optimize_prompt(self, user_message: str) -> str:
        """
        ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
        
        ì§ˆë¬¸ ìœ í˜•ì„ ê°ì§€í•˜ê³  ê° ìœ í˜•ì— ë§ëŠ” êµ¬ì¡°í™”ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì—¬
        ë” ì •í™•í•˜ê³  ìœ ìš©í•œ ì‘ë‹µì„ ì–»ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
        
        Args:
            user_message: ì›ë³¸ ì‚¬ìš©ì ì§ˆë¬¸
            
        Returns:
            str: ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ (ë˜ëŠ” ì›ë³¸ ë©”ì‹œì§€)
        """
        
        # ì§ˆë¬¸ ìœ í˜• ê°ì§€
        question_type = self._detect_question_type(user_message)
        
        # ìœ í˜•ë³„ ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±
        if question_type == "code_help":
            return f"""ë‹¤ìŒ í”„ë¡œê·¸ë˜ë° ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ ëª…í™•í•˜ê³  ì‹¤ìš©ì ì¸ ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”:

ì§ˆë¬¸: {user_message}

ë‹µë³€ ì‹œ ë‹¤ìŒì„ í¬í•¨í•´ì£¼ì„¸ìš”:
- í•µì‹¬ í•´ê²° ë°©ë²•
- ê°„ë‹¨í•œ ì½”ë“œ ì˜ˆì‹œ (í•„ìš”ì‹œ)
- ì£¼ì˜ì‚¬í•­ì´ë‚˜ íŒ

ê°„ê²°í•˜ê³  ì‹¤ìš©ì ì¸ ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”."""

        elif question_type == "explanation":
            return f"""ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”:

ì§ˆë¬¸: {user_message}

ë‹µë³€ ì‹œ:
- í•µì‹¬ ê°œë…ì„ ëª…í™•íˆ ì„¤ëª…
- êµ¬ì²´ì ì¸ ì˜ˆì‹œ í¬í•¨
- ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•˜ì—¬ ì„¤ëª…

ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ì œê³µí•´ì£¼ì„¸ìš”."""

        elif question_type == "comparison":
            return f"""ë‹¤ìŒ ë¹„êµ ìš”ì²­ì— ëŒ€í•´ ê°ê´€ì ì´ê³  êµ¬ì¡°í™”ëœ ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”:

ì§ˆë¬¸: {user_message}

ë‹µë³€ ì‹œ:
- ì£¼ìš” ì°¨ì´ì ê³¼ ê³µí†µì 
- ê°ê°ì˜ ì¥ë‹¨ì 
- ì‚¬ìš© ìƒí™©ë³„ ê¶Œì¥ì‚¬í•­

ê· í˜• ì¡íŒ ë¹„êµ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”."""

        elif question_type == "troubleshooting":
            return f"""ë‹¤ìŒ ë¬¸ì œ í•´ê²° ìš”ì²­ì— ëŒ€í•´ ë‹¨ê³„ë³„ í•´ê²° ë°©ë²•ì„ ì œê³µí•´ì£¼ì„¸ìš”:

ë¬¸ì œ: {user_message}

ë‹µë³€ ì‹œ:
- ê°€ëŠ¥í•œ ì›ì¸ë“¤
- ë‹¨ê³„ë³„ í•´ê²° ë°©ë²•
- ì˜ˆë°© ë°©ë²•

ì‹¤ìš©ì ì´ê³  ë”°ë¼í•˜ê¸° ì‰¬ìš´ í•´ê²°ì±…ì„ ì œê³µí•´ì£¼ì„¸ìš”."""

        else:  # ì¼ë°˜ ì§ˆë¬¸ â€“ ì›ë³¸ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ë°˜í™˜
            return user_message

    def _detect_question_type(self, message: str) -> str:
        """
        ì§ˆë¬¸ ìœ í˜• ê°ì§€
        
        í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ì„ ë¶„ë¥˜í•˜ì—¬ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ ìµœì í™” ì „ëµì„ ì„ íƒí•©ë‹ˆë‹¤.
        
        Args:
            message: ì‚¬ìš©ì ì§ˆë¬¸ ë©”ì‹œì§€
            
        Returns:
            str: ì§ˆë¬¸ ìœ í˜• ("code_help", "explanation", "comparison", "troubleshooting", "general")
        """
        message_lower = message.lower()
        
        # ì½”ë”©/í”„ë¡œê·¸ë˜ë° ê´€ë ¨ í‚¤ì›Œë“œ
        code_keywords = [
            'ì½”ë“œ', 'code', 'í”„ë¡œê·¸ë˜ë°', 'programming', 'í•¨ìˆ˜', 'function', 
            'ì—ëŸ¬', 'error', 'ë²„ê·¸', 'bug', 'êµ¬í˜„', 'implement', 'python', 
            'javascript', 'java', 'c++', 'sql', 'html', 'css', 'ì•Œê³ ë¦¬ì¦˜',
            'algorithm', 'ë¼ì´ë¸ŒëŸ¬ë¦¬', 'library', 'í”„ë ˆì„ì›Œí¬', 'framework'
        ]
        if any(keyword in message_lower for keyword in code_keywords):
            return "code_help"
        
        # ì„¤ëª… ìš”ì²­ í‚¤ì›Œë“œ
        explain_keywords = [
            'ì„¤ëª…', 'ë­ì•¼', 'ë¬´ì—‡', 'what', 'explain', 'ì°¨ì´', 'difference',
            'ì–´ë–»ê²Œ', 'how', 'ì™œ', 'why', 'ì˜ë¯¸', 'meaning', 'ê°œë…', 'concept',
            'ì •ì˜', 'definition', 'ì›ë¦¬', 'principle'
        ]
        if any(keyword in message_lower for keyword in explain_keywords):
            return "explanation"
        
        # ë¹„êµ ìš”ì²­ í‚¤ì›Œë“œ
        compare_keywords = [
            'ë¹„êµ', 'compare', 'vs', 'ëŒ€', 'ì°¨ì´ì ', 'ì¥ë‹¨ì ', 'ì–´ëŠê²Œ',
            'ì–´ë–¤ê²Œ', 'which', 'better', 'ì¢‹ì€', 'ì¶”ì²œ', 'recommend'
        ]
        if any(keyword in message_lower for keyword in compare_keywords):
            return "comparison"
        
        # ë¬¸ì œ í•´ê²° í‚¤ì›Œë“œ
        trouble_keywords = [
            'ë¬¸ì œ', 'problem', 'ì•ˆë¼', 'ì•ˆë˜', 'ì˜¤ë¥˜', 'ì—ëŸ¬', 'error',
            'í•´ê²°', 'solve', 'ê³ ì¹˜', 'fix', 'ì‘ë™', 'ì‹¤í–‰', 'run',
            'ë„ì›€', 'help', 'íŠ¸ëŸ¬ë¸”', 'trouble', 'ì´ìŠˆ', 'issue'
        ]
        if any(keyword in message_lower for keyword in trouble_keywords):
            return "troubleshooting"
        
        return "general"
